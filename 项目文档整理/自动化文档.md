# è‡ªåŠ¨åŒ–æ–‡æ¡£

[â† è¿”å›README](../README.md)

---

## ğŸ“‹ ç›®å½•

1. [è‡ªåŠ¨åŒ–åŸç†](#è‡ªåŠ¨åŒ–åŸç†)
2. [æ ¸å¿ƒæµç¨‹](#æ ¸å¿ƒæµç¨‹)
3. [UIå…ƒç´ å®šä½](#uiå…ƒç´ å®šä½)
4. [äº‹ä»¶å¤„ç†](#äº‹ä»¶å¤„ç†)
5. [çŠ¶æ€ç›‘æ§](#çŠ¶æ€ç›‘æ§)
6. [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)

---

## ğŸ” è‡ªåŠ¨åŒ–åŸç†

### Accessibility Serviceå·¥ä½œåŸç†

Accessibility Serviceæ˜¯Androidç³»ç»Ÿæä¾›çš„æ— éšœç¢æœåŠ¡æ¡†æ¶,ä¸»è¦ç”¨äºå¸®åŠ©æ®‹éšœäººå£«ä½¿ç”¨Androidè®¾å¤‡ã€‚ä½†åŒæ—¶ä¹Ÿå¯ä»¥ç”¨äºUIè‡ªåŠ¨åŒ–ã€‚

#### æ ¸å¿ƒæœºåˆ¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Androidç³»ç»Ÿ                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Accessibility Manager      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“ äº‹ä»¶åˆ†å‘                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Accessibility Service      â”‚   â”‚
â”‚  â”‚  (è‡ªåŠ¨åŒ–æœåŠ¡)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“ è·å–UIä¿¡æ¯              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AccessibilityNodeInfo      â”‚   â”‚
â”‚  â”‚  (UIèŠ‚ç‚¹æ ‘)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ æ§åˆ¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç›®æ ‡åº”ç”¨ (æƒåˆ©å«å£«)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…³é”®èƒ½åŠ›
1. **ç›‘å¬UIäº‹ä»¶** - çª—å£å˜åŒ–ã€å†…å®¹å˜åŒ–ã€ç„¦ç‚¹å˜åŒ–ç­‰
2. **è·å–UIä¿¡æ¯** - æ§ä»¶å±‚çº§ã€å±æ€§ã€æ–‡æœ¬ã€ä½ç½®ç­‰
3. **æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œ** - ç‚¹å‡»ã€æ»‘åŠ¨ã€è¾“å…¥ã€æ‰‹åŠ¿ç­‰
4. **è·¨åº”ç”¨æ“ä½œ** - å¯ä»¥æ§åˆ¶ä»»ä½•åº”ç”¨çš„UI

### æŠ€æœ¯ä¼˜åŠ¿

| ç‰¹æ€§ | Accessibility Service | UI Automator | Instrumentation |
|------|---------------------|--------------|-----------------|
| **æ— éœ€Root** | âœ… | âœ… | âœ… |
| **è·¨åº”ç”¨** | âœ… | âœ… | âŒ |
| **åå°è¿è¡Œ** | âœ… | âŒ | âŒ |
| **å®æ—¶ç›‘æ§** | âœ… | âŒ | âœ… |
| **ç”¨æˆ·æˆæƒ** | éœ€è¦ | ä¸éœ€è¦ | ä¸éœ€è¦ |

---

## ğŸ”„ æ ¸å¿ƒæµç¨‹

### å®Œæ•´è‡ªåŠ¨åŒ–æµç¨‹ (V1.8)

```
å¼€å§‹
  â†“
1. ç”¨æˆ·åœ¨APKä¸­ç²˜è´´å–è¯ä¿¡æ¯
  â†“
2. APKæ™ºèƒ½è§£æå–è¯ä¿¡æ¯
  â”œâ”€ æå–åŸåˆ›åç§°
  â”œâ”€ æå–ä¾µæƒäººåç§°
  â”œâ”€ æ™ºèƒ½æå–åŸåˆ›é“¾æ¥(å¿½ç•¥æè¿°æ–‡å­—)
  â””â”€ æ™ºèƒ½æå–ä¾µæƒé“¾æ¥(å¿½ç•¥æè¿°æ–‡å­—)
  â†“
3. ç”Ÿæˆå¤‡æ³¨: "åŸåˆ›åç§°-æŠ–éŸ³:ä¾µæƒäººåç§°"
  â†“
4. å¯åŠ¨è‡ªåŠ¨åŒ–æœåŠ¡
  â†“
5. æ£€æŸ¥æƒé™å’Œç¯å¢ƒ
  â†“
6. æœ€å°åŒ–å½“å‰åº”ç”¨(è¿”å›æ¡Œé¢)
  â†“
7. å»¶è¿Ÿ500ms
  â†“
8. å¯åŠ¨æƒåˆ©å«å£«åº”ç”¨
  â†“
9. ç›‘å¬çª—å£å˜åŒ–äº‹ä»¶
  â†“
10. æ£€æµ‹åˆ°ä¸»ç•Œé¢åŠ è½½
  â†“
11. ç­‰å¾…2ç§’(ç•Œé¢å®Œå…¨åŠ è½½)
  â†“
12. æŸ¥æ‰¾"å½•å±å–è¯"æŒ‰é’®
  â†“
13. ç‚¹å‡»"å½•å±å–è¯"æŒ‰é’®
  â†“
14. è¿›å…¥å½•å±ç•Œé¢
  â†“
15. ç­‰å¾…2ç§’(ç•Œé¢åŠ è½½)
  â†“
16. å¡«å……å¤‡æ³¨å†…å®¹åˆ°è¾“å…¥æ¡† (åªå¡«å……"åŸåˆ›åç§°-æŠ–éŸ³:ä¾µæƒäººåç§°")
  â†“
17. ç‚¹å‡»"å¼€å§‹å½•å±å–è¯"æŒ‰é’®
  â†“
18. ç³»ç»Ÿå½•å±æƒé™å¼¹çª—å‡ºç° âœ…
  â†“
19. å¤„ç†ç³»ç»Ÿå½•å±æƒé™å¼¹çª— âœ…
  â”œâ”€ 19.1 æ£€æµ‹æŒ‰é’®æ–‡å­—
  â”‚   â”œâ”€ æ˜¯"ç«‹å³å¼€å§‹"? â†’ ç›´æ¥ç‚¹å‡» â†’ å½•å±å¼€å§‹ âœ…
  â”‚   â””â”€ ä¸æ˜¯ â†’ ç»§ç»­
  â”œâ”€ 19.2 æ£€æµ‹ä¸‹æ‹‰æ¡†æ–‡å­—
  â”‚   â”œâ”€ æ˜¯"å•ä¸ªåº”ç”¨"? â†’ ç‚¹å‡»ä¸‹æ‹‰æ¡†
  â”‚   â””â”€ ä¸æ˜¯ â†’ è·³è¿‡
  â”œâ”€ 19.3 ç­‰å¾…500ms(èœå•å±•å¼€)
  â”œâ”€ 19.4 æŸ¥æ‰¾"æ•´ä¸ªå±å¹•"é€‰é¡¹
  â”œâ”€ 19.5 æ™ºèƒ½çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾
  â”‚   â”œâ”€ èŠ‚ç‚¹å¯ç‚¹å‡»? â†’ ç›´æ¥ç‚¹å‡»
  â”‚   â””â”€ ä¸å¯ç‚¹å‡»? â†’ ç‚¹å‡»çˆ¶èŠ‚ç‚¹
  â”œâ”€ 19.6 ç‚¹å‡»"æ•´ä¸ªå±å¹•"é€‰é¡¹
  â”œâ”€ 19.7 æŒ‰é’®å˜ä¸º"ç«‹å³å¼€å§‹"
  â””â”€ 19.8 ä¸‹æ¬¡äº‹ä»¶è§¦å‘æ—¶ç‚¹å‡»"ç«‹å³å¼€å§‹" â†’ å½•å±å¼€å§‹ âœ…
  â†“
20. å½•å±æˆåŠŸå¼€å§‹ âœ…
  â†“
21. ç›‘æ§å½•å±çŠ¶æ€(å¾…å¼€å‘)
  â†“
22. ç­‰å¾…å½•å±å®Œæˆ(å¾…å¼€å‘)
  â†“
23. ç‚¹å‡»åœæ­¢å½•å±(å¾…å¼€å‘)
  â†“
24. ç­‰å¾…ä¿å­˜å®Œæˆ(å¾…å¼€å‘)
  â†“
ç»“æŸ
```

### æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹

#### 0. æ™ºèƒ½å–è¯ä¿¡æ¯è§£æ (V1.8æ–°å¢)

**åŠŸèƒ½**: æ™ºèƒ½è§£æå¤šç»´è¡¨æ ¼å¤åˆ¶çš„å–è¯ä¿¡æ¯,è‡ªåŠ¨æå–URL

**è§£ææµç¨‹**:
```java
è¾“å…¥: "éƒ­æƒ æ–‡-æŠ–éŸ³:æ–‡æ–‡å·¥è‰ºå“-7.48 å¤åˆ¶æ‰“å¼€æŠ–éŸ³... https://v.douyin.com/xxx AgB:/ 05/17+https://www.douyin.com/yyy"
  â†“
1. æå–åŸåˆ›åç§°: "éƒ­æƒ æ–‡"
2. æå–ä¾µæƒäºº: "æ–‡æ–‡å·¥è‰ºå“"
3. æ™ºèƒ½æå–ç¬¬ä¸€ä¸ªURL: "https://v.douyin.com/xxx"
4. æ™ºèƒ½æå–ç¬¬äºŒä¸ªURL: "https://www.douyin.com/yyy"
  â†“
è¾“å‡ºå¤‡æ³¨: "éƒ­æƒ æ–‡-æŠ–éŸ³:æ–‡æ–‡å·¥è‰ºå“"
```

**æŠ€æœ¯å®ç°**:
- âœ… ä½¿ç”¨ `indexOf()` æŸ¥æ‰¾ `http://` æˆ– `https://` ä½ç½®
- âœ… ä»URLå¼€å§‹ä½ç½®æå–,ç›´åˆ°é‡åˆ°ç©ºç™½å­—ç¬¦
- âœ… è‡ªåŠ¨å¿½ç•¥URLå‰åçš„æè¿°æ–‡å­—
- âœ… æ”¯æŒå¤šç§URLæ ¼å¼ (v.douyin.com, www.douyin.comç­‰)

**ä¼˜åŠ¿**:
- âœ… ç”¨æˆ·æ— éœ€æ‰‹åŠ¨æ¸…ç†é“¾æ¥
- âœ… ç›´æ¥å¤åˆ¶ç²˜è´´å³å¯
- âœ… æé«˜æ“ä½œæ•ˆç‡
- âœ… å‡å°‘æ ¼å¼é”™è¯¯

#### 1. æ–‡å­—æŸ¥æ‰¾å®šä½ (ä¸»è¦æ–¹å¼)

**åŸç†**: é€šè¿‡æŒ‰é’®æ–‡å­—å®šä½å…ƒç´ ,ä¸ä¾èµ–Resource ID

**ä¼˜ç‚¹**:
- âœ… ä¸éœ€è¦dumpé¡µé¢
- âœ… ä¸éœ€è¦å¼€å¯è°ƒè¯•
- âœ… é€‚é…æ€§å¼º
- âœ… ä»£ç ç®€æ´

**ç¤ºä¾‹**:
```java
// æŸ¥æ‰¾"å½•å±å–è¯"æŒ‰é’®
List<AccessibilityNodeInfo> nodes =
    rootNode.findAccessibilityNodeInfosByText("å½•å±å–è¯");

if (nodes != null && !nodes.isEmpty()) {
    nodes.get(0).performAction(ACTION_CLICK);
}
```

#### 2. æ™ºèƒ½çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾

**é—®é¢˜**: æŸäº›å…ƒç´ (å¦‚ä¸‹æ‹‰èœå•é€‰é¡¹)æœ¬èº«ä¸å¯ç‚¹å‡»,éœ€è¦ç‚¹å‡»çˆ¶èŠ‚ç‚¹

**è§£å†³æ–¹æ¡ˆ**:
```java
// æŸ¥æ‰¾"æ•´ä¸ªå±å¹•"é€‰é¡¹
List<AccessibilityNodeInfo> nodes =
    rootNode.findAccessibilityNodeInfosByText("æ•´ä¸ªå±å¹•");

if (nodes != null && !nodes.isEmpty()) {
    AccessibilityNodeInfo node = nodes.get(0);

    // å¦‚æœèŠ‚ç‚¹ä¸å¯ç‚¹å‡»,å°è¯•ç‚¹å‡»çˆ¶èŠ‚ç‚¹
    if (!node.isClickable()) {
        AccessibilityNodeInfo parent = node.getParent();
        if (parent != null && parent.isClickable()) {
            parent.performAction(ACTION_CLICK);
            Log.d(TAG, "ç‚¹å‡»çˆ¶èŠ‚ç‚¹æˆåŠŸ");
        }
    } else {
        node.performAction(ACTION_CLICK);
        Log.d(TAG, "ç›´æ¥ç‚¹å‡»æˆåŠŸ");
    }
}
```

**æ•ˆæœ**: æˆåŠŸè§£å†³ä¸‹æ‹‰èœå•é€‰é¡¹ç‚¹å‡»é—®é¢˜

#### 3. çŠ¶æ€æ£€æµ‹ä¸åˆ¤æ–­ (V1.4ä¼˜åŒ–)

**é—®é¢˜**: ç³»ç»Ÿå½•å±æƒé™å¼¹çª—æœ‰ä¸¤ç§çŠ¶æ€
- çŠ¶æ€1: "å•ä¸ªåº”ç”¨" + "ç»§ç»­"æŒ‰é’®
- çŠ¶æ€2: "æ•´ä¸ªå±å¹•" + "ç«‹å³å¼€å§‹"æŒ‰é’®

**æ ¸å¿ƒéš¾ç‚¹**:
1. æŒ‰é’®æ–‡æœ¬æ— æ³•é€šè¿‡`getText()`è·å–(å¯èƒ½æ˜¾ç¤ºåœ¨å­èŠ‚ç‚¹)
2. ç‚¹å‡»"å•ä¸ªåº”ç”¨"åå¦‚æœä¸return,ä¼šç«‹å³æ‰§è¡Œåç»­ä»£ç å¯¼è‡´è¯¯ç‚¹å‡»
3. éœ€è¦åˆç†çš„ç­‰å¾…æ—¶é—´è®©ç•Œé¢å®Œå…¨æ›´æ–°

**è§£å†³æ–¹æ¡ˆ (V1.4)**:
```java
// 1. å…ˆæŸ¥æ‰¾"å•ä¸ªåº”ç”¨"æ–‡æœ¬
List<AccessibilityNodeInfo> spinnerNodes =
    rootNode.findAccessibilityNodeInfosByText("å•ä¸ªåº”ç”¨");

if (spinnerNodes != null && !spinnerNodes.isEmpty()) {
    // æ‰¾åˆ°"å•ä¸ªåº”ç”¨",ç‚¹å‡»ä¸‹æ‹‰æ¡†
    boolean clicked = spinnerNodes.get(0).performAction(ACTION_CLICK);

    if (clicked) {
        logD("âœ… æˆåŠŸç‚¹å‡»'å•ä¸ªåº”ç”¨'ä¸‹æ‹‰æ¡†,ç­‰å¾…ä¸‹æ‹‰èœå•å±•å¼€...");

        // åœ¨æ–°çº¿ç¨‹ä¸­ç­‰å¾…1500msåç‚¹å‡»"æ•´ä¸ªå±å¹•"
        new Thread(() -> {
            Thread.sleep(1500);
            clickWholeScreenOption();
        }).start();

        // é‡è¦: ç«‹å³è¿”å›,ä¸è¦ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç !
        rootNode.recycle();
        return;
    }
} else {
    // æœªæ‰¾åˆ°"å•ä¸ªåº”ç”¨",æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯"æ•´ä¸ªå±å¹•"æ¨¡å¼
    List<AccessibilityNodeInfo> wholeScreenNodes =
        rootNode.findAccessibilityNodeInfosByText("æ•´ä¸ªå±å¹•");

    if (wholeScreenNodes != null && !wholeScreenNodes.isEmpty()) {
        logD("âœ… å·²ç»æ˜¯'æ•´ä¸ªå±å¹•'æ¨¡å¼,æŸ¥æ‰¾ç¡®è®¤æŒ‰é’®");
        // é€šè¿‡IDæŸ¥æ‰¾å¹¶ç‚¹å‡»button1
        findAndClickButtonById(rootNode, "button1");
    }
}
```

**é€šè¿‡IDè¯†åˆ«æŒ‰é’® (æ ¸å¿ƒåˆ›æ–°)**:
```java
// ç­–ç•¥1: ç›´æ¥é€šè¿‡IDè¯†åˆ«button1(ç³»ç»Ÿå¯¹è¯æ¡†æ ‡å‡†ç¡®è®¤æŒ‰é’®)
if (viewId != null && viewId.endsWith("button1")) {
    logD("ğŸ¯ æ‰¾åˆ°ç³»ç»Ÿå¯¹è¯æ¡†ç¡®è®¤æŒ‰é’®: ID=" + viewId);

    boolean clicked = node.performAction(ACTION_CLICK);
    if (clicked) {
        logD("ğŸ‰ æˆåŠŸç‚¹å‡»ç¡®è®¤æŒ‰é’®,å½•å±å³å°†å¼€å§‹!");
        return;
    }
}
```

**æ•ˆæœ**:
- âœ… æ™ºèƒ½åˆ¤æ–­çŠ¶æ€,è‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„æ“ä½œ
- âœ… é€šè¿‡IDè¯†åˆ«æŒ‰é’®,ä¸ä¾èµ–æ–‡æœ¬(è§£å†³æ–‡æœ¬è·å–ä¸åˆ°çš„é—®é¢˜)
- âœ… ç‚¹å‡»åç«‹å³return,é¿å…è¯¯æ“ä½œ
- âœ… åˆç†çš„ç­‰å¾…æ—¶é—´(1500ms),ç¡®ä¿ç•Œé¢å®Œå…¨æ›´æ–°

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤1: å¯åŠ¨è‡ªåŠ¨åŒ–æœåŠ¡

**ç›®çš„**: åˆå§‹åŒ–Accessibility Service

**é…ç½®æ–‡ä»¶** (`res/xml/accessibility_service_config.xml`):
```xml
<?xml version="1.0" encoding="utf-8"?>
<accessibility-service xmlns:android="http://schemas.android.com/apk/res/android"
    android:accessibilityEventTypes="typeAllMask"
    android:accessibilityFeedbackType="feedbackGeneric"
    android:accessibilityFlags="flagDefault|flagReportViewIds|flagRetrieveInteractiveWindows"
    android:canPerformGestures="true"
    android:canRetrieveWindowContent="true"
    android:description="@string/accessibility_service_description"
    android:notificationTimeout="100" />
```

**âš ï¸ é‡è¦é…ç½®è¯´æ˜**:

1. **ä¸è¦é™åˆ¶packageNames**:
   - âŒ é”™è¯¯: `android:packageNames="com.android.systemui"`
   - âœ… æ­£ç¡®: ä¸è®¾ç½®`packageNames`å±æ€§,ç›‘å¬æ‰€æœ‰åº”ç”¨

2. **å¿…é¡»åŒ…å«çš„flags**:
   - `flagReportViewIds` - å…è®¸è·å–Viewçš„Resource ID
   - `flagRetrieveInteractiveWindows` - å…è®¸è·å–çª—å£å†…å®¹

3. **å¿…é¡»çš„æƒé™**:
   - `canPerformGestures="true"` - å…è®¸æ‰§è¡Œæ‰‹åŠ¿æ“ä½œ
   - `canRetrieveWindowContent="true"` - å…è®¸è¯»å–çª—å£å†…å®¹

**ä»£ç ç¤ºä¾‹**:
```java
public class AutomationAccessibilityService extends AccessibilityService {

    @Override
    public void onCreate() {
        super.onCreate();
        instance = this;
        Log.d(TAG, "æ— éšœç¢æœåŠ¡å·²åˆ›å»º");
    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        if (!isRunning) {
            return;
        }

        String packageName = event.getPackageName() != null ?
            event.getPackageName().toString() : "";

        // åªå¤„ç†æƒåˆ©å«å£«åº”ç”¨çš„äº‹ä»¶
        if (!TARGET_PACKAGE.equals(packageName)) {
            return;
        }

        int eventType = event.getEventType();
        Log.d(TAG, "æ”¶åˆ°äº‹ä»¶: " + AccessibilityEvent.eventTypeToString(eventType));

        // å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
        if (eventType == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED) {
            handleWindowStateChanged(event);
        }
    }
}
```

#### æ­¥éª¤2: æ£€æŸ¥æƒé™å’Œç¯å¢ƒ

**æ£€æŸ¥é¡¹**:
- æ— éšœç¢æœåŠ¡æ˜¯å¦å¼€å¯
- æ‚¬æµ®çª—æƒé™æ˜¯å¦æˆäºˆ
- æƒåˆ©å«å£«åº”ç”¨æ˜¯å¦å·²å®‰è£…
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

**ä»£ç ç¤ºä¾‹**:
```java
private boolean checkEnvironment() {
    // æ£€æŸ¥æ— éšœç¢æœåŠ¡
    if (!isAccessibilityEnabled()) {
        showError("è¯·å…ˆå¼€å¯æ— éšœç¢æœåŠ¡");
        return false;
    }
    
    // æ£€æŸ¥æƒåˆ©å«å£«æ˜¯å¦å®‰è£…
    if (!isAppInstalled("com.unitrust.tsa")) {
        showError("è¯·å…ˆå®‰è£…æƒåˆ©å«å£«åº”ç”¨");
        return false;
    }
    
    return true;
}
```

#### æ­¥éª¤3: å¯åŠ¨æƒåˆ©å«å£«åº”ç”¨

**å®Œæ•´æµç¨‹**:
1. æœ€å°åŒ–å½“å‰åº”ç”¨(è¿”å›æ¡Œé¢)
2. å»¶è¿Ÿ500ms
3. ä½¿ç”¨æ˜¾å¼Intentå¯åŠ¨æƒåˆ©å«å£«

**ä»£ç ç¤ºä¾‹**:
```java
public void startAutomation() {
    Log.d(TAG, "å¯åŠ¨è‡ªåŠ¨åŒ–");
    isRunning = true;

    // æœ€å°åŒ–å½“å‰åº”ç”¨(è¿”å›æ¡Œé¢)
    minimizeCurrentApp();

    // å»¶è¿Ÿæ‰“å¼€åº”ç”¨
    delayedOpenApp();
}

/**
 * æœ€å°åŒ–å½“å‰åº”ç”¨(è¿”å›æ¡Œé¢)
 */
private void minimizeCurrentApp() {
    try {
        Log.d(TAG, "æœ€å°åŒ–å½“å‰åº”ç”¨");
        Intent homeIntent = new Intent(Intent.ACTION_MAIN);
        homeIntent.addCategory(Intent.CATEGORY_HOME);
        homeIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(homeIntent);
        Log.d(TAG, "å·²è¿”å›æ¡Œé¢");
    } catch (Exception e) {
        Log.e(TAG, "æœ€å°åŒ–å¤±è´¥: " + e.getMessage(), e);
    }
}

/**
 * å»¶è¿Ÿæ‰“å¼€åº”ç”¨
 */
private void delayedOpenApp() {
    DelayThread thread = new DelayThread();
    thread.start();
}

/**
 * å»¶è¿Ÿçº¿ç¨‹
 */
private static class DelayThread extends Thread {
    @Override
    public void run() {
        try {
            Thread.sleep(500);
            if (instance != null) {
                instance.openTargetApp();
            }
        } catch (Exception e) {
            Log.e(TAG, "å»¶è¿Ÿæ‰“å¼€åº”ç”¨å¤±è´¥: " + e.getMessage());
        }
    }
}

/**
 * æ‰“å¼€ç›®æ ‡åº”ç”¨
 */
private void openTargetApp() {
    try {
        Log.d(TAG, "å°è¯•æ‰“å¼€æƒåˆ©å«å£«åº”ç”¨: " + TARGET_PACKAGE);

        // ä½¿ç”¨æ˜¾å¼Intentå¯åŠ¨
        Intent intent = new Intent();
        intent.setClassName(TARGET_PACKAGE, TARGET_ACTIVITY);
        intent.setAction(Intent.ACTION_MAIN);
        intent.addCategory(Intent.CATEGORY_LAUNCHER);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);

        startActivity(intent);
        Log.d(TAG, "æˆåŠŸå¯åŠ¨æƒåˆ©å«å£«åº”ç”¨");

    } catch (Exception e) {
        Log.e(TAG, "å¯åŠ¨æƒåˆ©å«å£«å¤±è´¥: " + e.getMessage(), e);
    }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:

1. **æœ€å°åŒ–åº”ç”¨**: ä½¿ç”¨`Intent.ACTION_MAIN`å’Œ`Intent.CATEGORY_HOME`è¿”å›æ¡Œé¢
2. **å»¶è¿Ÿå¯åŠ¨**: ä½¿ç”¨é™æ€å†…éƒ¨ç±»`DelayThread`é¿å…åŒ¿åå†…éƒ¨ç±»ç¼–è¯‘é”™è¯¯
3. **æ˜¾å¼Intent**: ä½¿ç”¨`setClassName()`æ˜ç¡®æŒ‡å®šActivity,æ¯”`getLaunchIntentForPackage()`æ›´å¯é 
4. **Activityåç§°**: æƒåˆ©å«å£«çš„å¯åŠ¨Activityæ˜¯`cn.tsa.activity.SplashActivity`

**å¸¸è§é—®é¢˜**:

- âŒ `getLaunchIntentForPackage()`å¯èƒ½è¿”å›null
- âŒ åŒ¿åå†…éƒ¨ç±»åœ¨æŸäº›Androidç‰ˆæœ¬ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯
- âœ… ä½¿ç”¨æ˜¾å¼Intentå’Œé™æ€å†…éƒ¨ç±»æ›´ç¨³å®š

#### æ­¥éª¤4-8: ç›‘å¬çª—å£å˜åŒ–å¹¶ç‚¹å‡»"å½•å±å–è¯"

**å®Œæ•´æµç¨‹**:
1. ç›‘å¬çª—å£çŠ¶æ€å˜åŒ–äº‹ä»¶
2. æ£€æµ‹åˆ°æƒåˆ©å«å£«ä¸»ç•Œé¢
3. ç­‰å¾…2ç§’è®©ç•Œé¢å®Œå…¨åŠ è½½
4. æŸ¥æ‰¾"å½•å±å–è¯"æŒ‰é’®
5. ç‚¹å‡»æŒ‰é’®è¿›å…¥å½•å±ç•Œé¢

**ä»£ç ç¤ºä¾‹**:
```java
@Override
public void onAccessibilityEvent(AccessibilityEvent event) {
    if (!isRunning) {
        return;
    }

    String packageName = event.getPackageName() != null ?
        event.getPackageName().toString() : "";

    // åªå¤„ç†æƒåˆ©å«å£«åº”ç”¨çš„äº‹ä»¶
    if (!TARGET_PACKAGE.equals(packageName)) {
        return;
    }

    int eventType = event.getEventType();
    Log.d(TAG, "æ”¶åˆ°äº‹ä»¶: " + AccessibilityEvent.eventTypeToString(eventType));

    // å¤„ç†çª—å£çŠ¶æ€å˜åŒ–äº‹ä»¶
    if (eventType == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED) {
        handleWindowStateChanged(event);
    }

    // å¤„ç†çª—å£å†…å®¹å˜åŒ–äº‹ä»¶
    if (eventType == AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED) {
        handleWindowContentChanged();
    }
}

/**
 * å¤„ç†çª—å£çŠ¶æ€å˜åŒ–
 */
private void handleWindowStateChanged(AccessibilityEvent event) {
    String className = event.getClassName() != null ?
        event.getClassName().toString() : "";
    Log.d(TAG, "çª—å£åˆ‡æ¢: " + className);

    // æ£€æµ‹åˆ°ä¸»ç•Œé¢,å°è¯•ç‚¹å‡»å½•å±å–è¯æŒ‰é’®
    if (!hasClickedScreenRecord) {
        ClickScreenRecordThread thread = new ClickScreenRecordThread();
        thread.start();
    }
}

/**
 * ç‚¹å‡»å½•å±å–è¯æŒ‰é’®çš„çº¿ç¨‹
 */
private static class ClickScreenRecordThread extends Thread {
    @Override
    public void run() {
        try {
            Thread.sleep(2000); // ç­‰å¾…ç•Œé¢åŠ è½½
            if (instance != null && !instance.hasClickedScreenRecord) {
                instance.clickScreenRecordButton();
            }
        } catch (Exception e) {
            Log.e(TAG, "ç‚¹å‡»å½•å±å–è¯å¤±è´¥: " + e.getMessage());
        }
    }
}

/**
 * ç‚¹å‡»å½•å±å–è¯æŒ‰é’®
 */
private void clickScreenRecordButton() {
    try {
        Log.d(TAG, "å°è¯•ç‚¹å‡»å½•å±å–è¯æŒ‰é’®");

        AccessibilityNodeInfo rootNode = getRootInActiveWindow();
        if (rootNode == null) {
            Log.e(TAG, "æ— æ³•è·å–æ ¹èŠ‚ç‚¹");
            return;
        }

        // é€šè¿‡Resource IDæŸ¥æ‰¾æŒ‰é’®
        List<AccessibilityNodeInfo> nodes =
            rootNode.findAccessibilityNodeInfosByViewId(SCREEN_RECORD_BUTTON_ID);

        if (nodes != null && !nodes.isEmpty()) {
            AccessibilityNodeInfo buttonNode = nodes.get(0);

            // æ‰§è¡Œç‚¹å‡»
            boolean clicked = buttonNode.performAction(
                AccessibilityNodeInfo.ACTION_CLICK
            );

            if (clicked) {
                Log.d(TAG, "æˆåŠŸç‚¹å‡»å½•å±å–è¯æŒ‰é’®");
                hasClickedScreenRecord = true;
            } else {
                Log.e(TAG, "ç‚¹å‡»å½•å±å–è¯æŒ‰é’®å¤±è´¥");
            }

            // é‡Šæ”¾èµ„æº
            buttonNode.recycle();
        } else {
            Log.e(TAG, "æœªæ‰¾åˆ°å½•å±å–è¯æŒ‰é’®");
        }

        rootNode.recycle();

    } catch (Exception e) {
        Log.e(TAG, "ç‚¹å‡»å½•å±å–è¯æŒ‰é’®å¼‚å¸¸: " + e.getMessage(), e);
    }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:

1. **Resource IDå®šä½**: ä½¿ç”¨`com.unitrust.tsa:id/screen_record_layout`ç²¾ç¡®å®šä½æŒ‰é’®
2. **å»¶è¿Ÿç­‰å¾…**: ç­‰å¾…2ç§’ç¡®ä¿ç•Œé¢å®Œå…¨åŠ è½½
3. **é˜²æ­¢é‡å¤ç‚¹å‡»**: ä½¿ç”¨`hasClickedScreenRecord`æ ‡å¿—ä½
4. **èµ„æºé‡Šæ”¾**: åŠæ—¶è°ƒç”¨`recycle()`é‡Šæ”¾AccessibilityNodeInfo

**UIå…ƒç´ ä¿¡æ¯**:
```java
private static final String SCREEN_RECORD_BUTTON_ID =
    "com.unitrust.tsa:id/screen_record_layout";
```

#### æ­¥éª¤12-15: å¡«å……å¤‡æ³¨å¹¶ç‚¹å‡»å¼€å§‹å½•å±

**å®Œæ•´æµç¨‹**:
1. æ£€æµ‹åˆ°å½•å±ç•Œé¢(ScreenRecorderActivity)
2. ç­‰å¾…2ç§’è®©ç•Œé¢å®Œå…¨åŠ è½½
3. å¡«å……ç”¨æˆ·è¾“å…¥çš„å¤‡æ³¨å†…å®¹
4. ç‚¹å‡»"å¼€å§‹å½•å±å–è¯"æŒ‰é’®

**ä»£ç ç¤ºä¾‹**:
```java
private void handleWindowStateChanged(AccessibilityEvent event) {
    String className = event.getClassName() != null ?
        event.getClassName().toString() : "";
    Log.d(TAG, "çª—å£åˆ‡æ¢: " + className);

    // æ£€æµ‹åˆ°å½•å±ç•Œé¢,å¡«å……å¤‡æ³¨å¹¶ç‚¹å‡»å¼€å§‹å½•å±
    if (className.equals("cn.tsa.rights.viewer.screen.ScreenRecorderActivity")) {
        Log.d(TAG, "æ£€æµ‹åˆ°å½•å±ç•Œé¢");
        FillRemarkAndStartThread thread = new FillRemarkAndStartThread();
        thread.start();
    }
}

/**
 * å¡«å……å¤‡æ³¨å¹¶ç‚¹å‡»å¼€å§‹å½•å±çš„çº¿ç¨‹
 */
private static class FillRemarkAndStartThread extends Thread {
    @Override
    public void run() {
        try {
            Thread.sleep(2000); // ç­‰å¾…ç•Œé¢åŠ è½½
            if (instance != null) {
                instance.fillRemarkAndStart();
            }
        } catch (Exception e) {
            Log.e(TAG, "å¡«å……å¤‡æ³¨å¹¶å¼€å§‹å½•å±å¤±è´¥: " + e.getMessage());
        }
    }
}

/**
 * å¡«å……å¤‡æ³¨å¹¶ç‚¹å‡»å¼€å§‹å½•å±
 */
private void fillRemarkAndStart() {
    try {
        Log.d(TAG, "å¼€å§‹å¡«å……å¤‡æ³¨å¹¶ç‚¹å‡»å¼€å§‹å½•å±");

        AccessibilityNodeInfo rootNode = getRootInActiveWindow();
        if (rootNode == null) {
            Log.e(TAG, "æ— æ³•è·å–æ ¹èŠ‚ç‚¹");
            return;
        }

        // 1. å¡«å……å¤‡æ³¨
        if (remark != null && !remark.isEmpty()) {
            List<AccessibilityNodeInfo> remarkNodes =
                rootNode.findAccessibilityNodeInfosByViewId(REMARK_INPUT_ID);

            if (remarkNodes != null && !remarkNodes.isEmpty()) {
                AccessibilityNodeInfo remarkNode = remarkNodes.get(0);

                // è®¾ç½®ç„¦ç‚¹
                remarkNode.performAction(AccessibilityNodeInfo.ACTION_FOCUS);

                // å¡«å……æ–‡æœ¬
                Bundle arguments = new Bundle();
                arguments.putCharSequence(
                    AccessibilityNodeInfo.ACTION_ARGUMENT_SET_TEXT_CHARSEQUENCE,
                    remark
                );
                boolean filled = remarkNode.performAction(
                    AccessibilityNodeInfo.ACTION_SET_TEXT,
                    arguments
                );

                if (filled) {
                    Log.d(TAG, "æˆåŠŸå¡«å……å¤‡æ³¨: " + remark);
                } else {
                    Log.e(TAG, "å¡«å……å¤‡æ³¨å¤±è´¥");
                }

                remarkNode.recycle();
            } else {
                Log.e(TAG, "æœªæ‰¾åˆ°å¤‡æ³¨è¾“å…¥æ¡†");
            }
        }

        // ç­‰å¾…ä¸€ä¸‹,ç¡®ä¿å¤‡æ³¨å¡«å……å®Œæˆ
        Thread.sleep(500);

        // 2. ç‚¹å‡»å¼€å§‹å½•å±æŒ‰é’®
        List<AccessibilityNodeInfo> startNodes =
            rootNode.findAccessibilityNodeInfosByViewId(START_BUTTON_ID);

        if (startNodes != null && !startNodes.isEmpty()) {
            AccessibilityNodeInfo startNode = startNodes.get(0);

            // æ‰§è¡Œç‚¹å‡»
            boolean clicked = startNode.performAction(
                AccessibilityNodeInfo.ACTION_CLICK
            );

            if (clicked) {
                Log.d(TAG, "æˆåŠŸç‚¹å‡»å¼€å§‹å½•å±æŒ‰é’®");
            } else {
                Log.e(TAG, "ç‚¹å‡»å¼€å§‹å½•å±æŒ‰é’®å¤±è´¥");
            }

            startNode.recycle();
        } else {
            Log.e(TAG, "æœªæ‰¾åˆ°å¼€å§‹å½•å±æŒ‰é’®");
        }

        rootNode.recycle();

    } catch (Exception e) {
        Log.e(TAG, "å¡«å……å¤‡æ³¨å¹¶å¼€å§‹å½•å±å¼‚å¸¸: " + e.getMessage(), e);
    }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**:

1. **å¤‡æ³¨ä¼ é€’**:
   - MainActivityä¸­è·å–ç”¨æˆ·è¾“å…¥
   - é€šè¿‡`setRemark()`æ–¹æ³•ä¼ é€’ç»™Service
   - Serviceä¿å­˜å¤‡æ³¨å†…å®¹

2. **æ–‡æœ¬å¡«å……**:
   - ä½¿ç”¨`ACTION_FOCUS`è®¾ç½®ç„¦ç‚¹
   - ä½¿ç”¨`ACTION_SET_TEXT`å¡«å……æ–‡æœ¬
   - é€šè¿‡Bundleä¼ é€’æ–‡æœ¬å†…å®¹

3. **å»¶è¿Ÿç­‰å¾…**:
   - ç­‰å¾…2ç§’ç¡®ä¿ç•Œé¢åŠ è½½
   - å¡«å……åç­‰å¾…500msç¡®ä¿å®Œæˆ

4. **UIå…ƒç´ å®šä½**:
```java
private static final String REMARK_INPUT_ID = "com.unitrust.tsa:id/ed_remark";
private static final String START_BUTTON_ID = "com.unitrust.tsa:id/rl_btn";
```

#### æ­¥éª¤16: å¼€å§‹å½•å± âœ…

**çŠ¶æ€**: å·²å®Œæˆ

ç‚¹å‡»"å¼€å§‹å½•å±å–è¯"æŒ‰é’®å,å½•å±åŠŸèƒ½æ­£å¼å¯åŠ¨ã€‚

---

#### æ­¥éª¤17: å¤„ç†ç³»ç»Ÿå½•å±æƒé™å¼¹çª— âœ…

**çŠ¶æ€**: å·²å®Œæˆ

**åœºæ™¯**: ç‚¹å‡»"å¼€å§‹å½•å±"å,ç³»ç»Ÿå¼¹å‡ºå½•å±æƒé™ç¡®è®¤å¼¹çª—

**å¤„ç†æµç¨‹**: è¯¦è§ [ç³»ç»Ÿå½•å±æƒé™å¼¹çª—å¤„ç†](#ç³»ç»Ÿå½•å±æƒé™å¼¹çª—å¤„ç†) ç« èŠ‚

---

#### æ­¥éª¤18: å¤„ç†åº”ç”¨éªŒçœŸç•Œé¢ âœ…

**çŠ¶æ€**: å·²å®Œæˆ (V1.5)

**åœºæ™¯**: å½•å±å¼€å§‹å,æƒåˆ©å«å£«å¼¹å‡º"åº”ç”¨éªŒçœŸ"ç•Œé¢,éœ€è¦é€‰æ‹©è¦éªŒè¯çš„åº”ç”¨

**å®Œæ•´æµç¨‹**:

```
åº”ç”¨éªŒçœŸç•Œé¢å‡ºç°
    â†“
1. æ£€æµ‹"åº”ç”¨éªŒçœŸ"æ ‡é¢˜
    â†“
2. æŸ¥æ‰¾æŠ–éŸ³å®¹å™¨(ID: rl_douyin)
    â†“
3. ç‚¹å‡»æŠ–éŸ³å®¹å™¨(å‹¾é€‰æŠ–éŸ³)
    â†“
4. è®¾ç½®hasSelectedDouyin=true (é˜»æ­¢ä¸»å¾ªç¯é‡å¤ç‚¹å‡»)
    â†“
5. å¯åŠ¨å»¶è¿Ÿçº¿ç¨‹,éšæœºå»¶è¿Ÿ1-3ç§’
    â†“
6. æˆªå±ä¿å­˜åº”ç”¨éªŒçœŸé¡µé¢
    â†“
7. ç­‰å¾…æˆªå±å®Œæˆ(æœ€å¤š3ç§’)
    â†“
8. å†ç­‰å¾…500msç¡®ä¿ç•Œé¢ç¨³å®š
    â†“
9. ç‚¹å‡»"ç«‹å³éªŒè¯"æŒ‰é’®
    â†“
éªŒè¯å®Œæˆ,è¿›å…¥æŠ–éŸ³åº”ç”¨
```

**å…³é”®æŠ€æœ¯ç‚¹**:

1. **é˜»æ­¢é‡å¤ç‚¹å‡»**: ä½¿ç”¨`hasSelectedDouyin`æ ‡å¿—,é˜²æ­¢ä¸»å¾ªç¯åœ¨å»¶è¿ŸæœŸé—´é‡å¤ç‚¹å‡»"ç«‹å³éªŒè¯"
2. **éšæœºå»¶è¿Ÿ**: 1-3ç§’çš„éšæœºå»¶è¿Ÿ,æ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ“ä½œ
3. **åŒæ­¥ç­‰å¾…æˆªå±**: ä½¿ç”¨`CountDownLatch`ç¡®ä¿æˆªå±å®Œæˆåå†ç‚¹å‡»æŒ‰é’®
4. **æˆªå±æƒé™**: éœ€è¦åœ¨`accessibility_service_config.xml`ä¸­å£°æ˜`android:canTakeScreenshot="true"`
5. **ä¿å­˜åˆ°ç›¸å†Œ**: ä½¿ç”¨MediaStore APIä¿å­˜åˆ°å…¬å…±ç›¸å†Œ,æ–¹ä¾¿æŸ¥çœ‹

**æˆªå›¾ä¿å­˜ä½ç½®**:
```
ç›¸å†Œ / Pictures / æƒåˆ©å«å£«å–è¯ / åº”ç”¨éªŒçœŸ_è¢ä¸¹-æŠ–éŸ³_æµ·èµ«Hayhoeæœé¥°_20250120_200530.png
```

**Resource ID**:
```java
private static final String DOUYIN_CONTAINER_ID = "com.unitrust.tsa:id/rl_douyin";
private static final String VERIFY_BUTTON_ID = "com.unitrust.tsa:id/confirm_button";
```

---

## ğŸ¯ UIå…ƒç´ å®šä½

### å®šä½æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | ä¼˜å…ˆçº§ | ç¨³å®šæ€§ | é€‚ç”¨åœºæ™¯ |
|------|--------|--------|---------|
| **Resource ID** | â­â­â­â­â­ | é«˜ | é¦–é€‰æ–¹æ³• |
| **Textæ–‡æœ¬** | â­â­â­â­ | ä¸­ | Resource IDä¸å¯ç”¨æ—¶ |
| **Content Description** | â­â­â­ | ä¸­ | å›¾æ ‡æŒ‰é’® |
| **Class Name** | â­â­ | ä½ | è¾…åŠ©å®šä½ |
| **åæ ‡ä½ç½®** | â­ | æä½ | é¿å…ä½¿ç”¨ |

### æƒåˆ©å«å£«å…³é”®UIå…ƒç´ 

#### ä¸»ç•Œé¢å…ƒç´ 
```java
public class RightsGuardMainUIElements {
    // ä¸»ç•Œé¢åŠŸèƒ½æŒ‰é’®Resource ID
    public static final String CAMERA_LAYOUT = "com.unitrust.tsa:id/camera_layout";        // æ‹ç…§å–è¯
    public static final String VIDEO_LAYOUT = "com.unitrust.tsa:id/video_layout";          // å½•åƒå–è¯
    public static final String RADIO_LAYOUT = "com.unitrust.tsa:id/radio_layout";          // å½•éŸ³å–è¯
    public static final String WEB_LAYOUT = "com.unitrust.tsa:id/web_layout";              // ç½‘é¡µå–è¯
    public static final String SCREEN_RECORD_LAYOUT = "com.unitrust.tsa:id/screen_record_layout"; // å½•å±å–è¯
    public static final String VERIFICATION_LAYOUT = "com.unitrust.tsa:id/verification_layout";   // æ‰¾å¾‹å¸ˆ

    // æŒ‰é’®æ–‡æœ¬
    public static final String CAMERA_TEXT = "æ‹ç…§å–è¯";
    public static final String VIDEO_TEXT = "å½•åƒå–è¯";
    public static final String RADIO_TEXT = "å½•éŸ³å–è¯";
    public static final String WEB_TEXT = "ç½‘é¡µå–è¯";
    public static final String SCREEN_RECORD_TEXT = "å½•å±å–è¯";
    public static final String VERIFICATION_TEXT = "æ‰¾å¾‹å¸ˆ";
}
```

#### å½•å±ç•Œé¢å…ƒç´ 
```java
public class RightsGuardRecorderUIElements {
    // Activityç±»å
    public static final String SCREEN_RECORDER_ACTIVITY =
        "cn.tsa.rights.viewer.screen.ScreenRecorderActivity";

    // å…³é”®æ§ä»¶Resource ID
    public static final String START_BUTTON = "com.unitrust.tsa:id/rl_btn";           // å¼€å§‹å½•å±æŒ‰é’®
    public static final String REMARK_INPUT = "com.unitrust.tsa:id/ed_remark";        // å¤‡æ³¨è¾“å…¥æ¡† âœ…
    public static final String MIC_SWITCH = "com.unitrust.tsa:id/image_switch";       // éº¦å…‹é£å¼€å…³
    public static final String LOCATION_SWITCH = "com.unitrust.tsa:id/switch_screen"; // ä½ç½®ä¿¡æ¯å¼€å…³
    public static final String BACK_BUTTON = "com.unitrust.tsa:id/rl_back";           // è¿”å›æŒ‰é’®

    // æŒ‰é’®æ–‡æœ¬
    public static final String START_TEXT = "å¼€å§‹å½•å±å–è¯";
    public static final String STOP_TEXT = "åœæ­¢å½•å±";

    // è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
    public static final String REMARK_HINT = "è¾“å…¥è‡ªå®šä¹‰åç§°ï¼ˆé€‰å¡«ï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨è¯ä¹¦ä¸Šï¼‰";
}
```

### æ™ºèƒ½ç­‰å¾…æœºåˆ¶

**é—®é¢˜**: UIåŠ è½½éœ€è¦æ—¶é—´,ç›´æ¥æŸ¥æ‰¾å¯èƒ½å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**: å®ç°æ™ºèƒ½ç­‰å¾…

```java
private AccessibilityNodeInfo waitForElement(String resourceId, int maxWaitSeconds) {
    int waitCount = 0;
    int maxWaitCount = maxWaitSeconds * 10; // æ¯100msæ£€æŸ¥ä¸€æ¬¡

    while (waitCount < maxWaitCount) {
        AccessibilityNodeInfo rootNode = getRootInActiveWindow();
        if (rootNode != null) {
            List<AccessibilityNodeInfo> nodes =
                rootNode.findAccessibilityNodeInfosByViewId(resourceId);

            if (nodes != null && !nodes.isEmpty()) {
                Log.d(TAG, "æ‰¾åˆ°å…ƒç´ : " + resourceId);
                return nodes.get(0);
            }
        }

        SystemClock.sleep(100);
        waitCount++;
    }

    Log.e(TAG, "ç­‰å¾…å…ƒç´ è¶…æ—¶: " + resourceId);
    return null;
}
```

---

## ğŸ“¡ äº‹ä»¶å¤„ç†

### Accessibilityäº‹ä»¶ç±»å‹

```java
@Override
public void onAccessibilityEvent(AccessibilityEvent event) {
    int eventType = event.getEventType();

    switch (eventType) {
        case AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED:
            // çª—å£åˆ‡æ¢äº‹ä»¶
            handleWindowStateChanged(event);
            break;

        case AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED:
            // çª—å£å†…å®¹å˜åŒ–äº‹ä»¶
            handleWindowContentChanged(event);
            break;

        case AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED:
            // é€šçŸ¥æ å˜åŒ–äº‹ä»¶
            handleNotificationChanged(event);
            break;

        case AccessibilityEvent.TYPE_VIEW_CLICKED:
            // ç‚¹å‡»äº‹ä»¶
            handleViewClicked(event);
            break;
    }
}
```

### çª—å£çŠ¶æ€ç›‘æ§

**ç›®çš„**: ç›‘æ§åº”ç”¨åˆ‡æ¢å’Œç•Œé¢è·³è½¬

```java
private void handleWindowStateChanged(AccessibilityEvent event) {
    String packageName = event.getPackageName().toString();
    String className = event.getClassName().toString();

    Log.d(TAG, "çª—å£åˆ‡æ¢: " + packageName + " / " + className);

    // æ£€æŸ¥æ˜¯å¦æ˜¯æƒåˆ©å«å£«åº”ç”¨
    if (packageName.equals("com.unitrust.tsa")) {
        if (className.equals("cn.tsa.rights.viewer.screen.ScreenRecorderActivity")) {
            // å½•å±ç•Œé¢
            onRecordingScreenShown();
        } else if (className.equals("cn.tsa.activity.SplashActivity")) {
            // å¯åŠ¨é¡µ
            onSplashScreenShown();
        }
    }
}
```

### é€šçŸ¥æ ç›‘æ§

**ç›®çš„**: ç›‘æ§å½•å±çŠ¶æ€é€šçŸ¥

```java
private void handleNotificationChanged(AccessibilityEvent event) {
    if (event.getParcelableData() instanceof Notification) {
        Notification notification = (Notification) event.getParcelableData();

        // è·å–é€šçŸ¥å†…å®¹
        Bundle extras = notification.extras;
        String title = extras.getString(Notification.EXTRA_TITLE);
        String text = extras.getString(Notification.EXTRA_TEXT);

        Log.d(TAG, "é€šçŸ¥: " + title + " - " + text);

        // åˆ¤æ–­æ˜¯å¦æ˜¯å½•å±é€šçŸ¥
        if (title != null && title.contains("å½•å±")) {
            if (text != null && text.contains("æ­£åœ¨å½•åˆ¶")) {
                onRecordingStarted();
            } else if (text != null && text.contains("å·²åœæ­¢")) {
                onRecordingStopped();
            }
        }
    }
}
```

---

## ğŸ¯ ç³»ç»Ÿå½•å±æƒé™å¼¹çª—å¤„ç†

### å¼¹çª—ç»“æ„åˆ†æ

**ç³»ç»Ÿå¼¹çª—åŒ…å«**:
- æ ‡é¢˜: "ä½¿ç”¨"æƒåˆ©å«å£«"å½•åˆ¶æˆ–å…±äº«å±å¹•"
- è¯´æ˜æ–‡å­—: "å½•åˆ¶æˆ–å…±äº«å±å¹•æ—¶,æƒåˆ©å«å£«å°†è·å–æ‚¨å±å¹•ä¸Šçš„æ‰€æœ‰å†…å®¹..."
- ä¸‹æ‹‰æ¡†: "å•ä¸ªåº”ç”¨" / "æ•´ä¸ªå±å¹•"
- æŒ‰é’®: "ç»§ç»­" / "ç«‹å³å¼€å§‹"

**UIå±‚çº§ç»“æ„**:
```
com.android.systemui (ç³»ç»ŸUI)
  â””â”€ BottomSheet (åº•éƒ¨å¼¹çª—)
      â”œâ”€ Title: "ä½¿ç”¨"æƒåˆ©å«å£«"å½•åˆ¶æˆ–å…±äº«å±å¹•"
      â”œâ”€ Content: è¯´æ˜æ–‡å­—
      â”œâ”€ Spinner (ä¸‹æ‹‰æ¡†)
      â”‚   â”œâ”€ real_screen_share_mode_spinner (ID)
      â”‚   â””â”€ Text: "å•ä¸ªåº”ç”¨" / "æ•´ä¸ªå±å¹•"
      â””â”€ Button (æŒ‰é’®)
          â”œâ”€ android:id/button1 (ID)
          â””â”€ Text: "ç»§ç»­" / "ç«‹å³å¼€å§‹"
```

### è‡ªåŠ¨åŒ–å¤„ç†æµç¨‹

#### çŠ¶æ€æœºè®¾è®¡

```
ç³»ç»Ÿå¼¹çª—å‡ºç°
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹æŒ‰é’®æ–‡å­—                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ˜¯"ç«‹å³å¼€å§‹"? â”€â”€Yesâ”€â”€â†’ ç‚¹å‡»æŒ‰é’® â”€â”€â†’ å½•å±å¼€å§‹ âœ…
    â†“ No
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹ä¸‹æ‹‰æ¡†æ–‡å­—               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ˜¯"å•ä¸ªåº”ç”¨"? â”€â”€Yesâ”€â”€â†’ ç‚¹å‡»ä¸‹æ‹‰æ¡†
    â†“                      â†“
    No                 ç­‰å¾…500ms
    â†“                      â†“
  è·³è¿‡              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ æŸ¥æ‰¾"æ•´ä¸ªå±å¹•"   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
                    æ™ºèƒ½çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾
                           â†“
                    ç‚¹å‡»"æ•´ä¸ªå±å¹•"
                           â†“
                    æŒ‰é’®å˜ä¸º"ç«‹å³å¼€å§‹"
                           â†“
                    ä¸‹æ¬¡äº‹ä»¶è§¦å‘æ—¶ç‚¹å‡» âœ…
```

#### æ ¸å¿ƒä»£ç å®ç°

**1. ç›‘å¬ç³»ç»ŸUIäº‹ä»¶**

```java
@Override
public void onAccessibilityEvent(AccessibilityEvent event) {
    String packageName = event.getPackageName().toString();
    int eventType = event.getEventType();

    // å¤„ç†ç³»ç»ŸUIçš„å½•å±æƒé™å¼¹çª—
    if (SYSTEM_UI_PACKAGE.equals(packageName)) {
        if (eventType == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED ||
            eventType == AccessibilityEvent.TYPE_WINDOW_CONTENT_CHANGED) {
            handleSystemScreenShareDialog();
        }
        return;
    }
}
```

**2. å¤„ç†å¼¹çª—é€»è¾‘**

```java
private void handleSystemScreenShareDialog() {
    AccessibilityNodeInfo rootNode = getRootInActiveWindow();

    // ä¼˜å…ˆæ£€æµ‹"ç«‹å³å¼€å§‹"æŒ‰é’®
    List<AccessibilityNodeInfo> buttonNodes =
        rootNode.findAccessibilityNodeInfosByViewId(CONTINUE_BUTTON_ID);

    if (buttonNodes != null && !buttonNodes.isEmpty()) {
        CharSequence buttonText = buttonNodes.get(0).getText();

        // å¦‚æœæ˜¯"ç«‹å³å¼€å§‹",ç›´æ¥ç‚¹å‡»
        if (buttonText != null && buttonText.toString().contains("ç«‹å³å¼€å§‹")) {
            buttonNodes.get(0).performAction(ACTION_CLICK);
            Log.d(TAG, "æˆåŠŸç‚¹å‡»'ç«‹å³å¼€å§‹'æŒ‰é’®");
            return;
        }
    }

    // æ£€æµ‹"å•ä¸ªåº”ç”¨"ä¸‹æ‹‰æ¡†
    List<AccessibilityNodeInfo> spinnerNodes =
        rootNode.findAccessibilityNodeInfosByViewId(SCREEN_SHARE_MODE_SPINNER_ID);

    if (spinnerNodes != null && !spinnerNodes.isEmpty()) {
        CharSequence text = spinnerNodes.get(0).getText();

        // å¦‚æœæ˜¯"å•ä¸ªåº”ç”¨",ç‚¹å‡»æ‰“å¼€èœå•
        if (text != null && text.toString().contains("å•ä¸ªåº”ç”¨")) {
            spinnerNodes.get(0).performAction(ACTION_CLICK);
            Log.d(TAG, "æˆåŠŸç‚¹å‡»'å•ä¸ªåº”ç”¨'ä¸‹æ‹‰æ¡†");

            // å¼‚æ­¥ç‚¹å‡»"æ•´ä¸ªå±å¹•"
            new Thread(() -> {
                try {
                    Thread.sleep(500);
                    clickWholeScreenOption();
                } catch (Exception e) {
                    Log.e(TAG, "ç­‰å¾…ä¸‹æ‹‰èœå•å¼‚å¸¸: " + e.getMessage());
                }
            }).start();
        }
    }
}
```

**3. æ™ºèƒ½çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾**

```java
private void clickWholeScreenOption() {
    AccessibilityNodeInfo rootNode = getRootInActiveWindow();

    // æŸ¥æ‰¾"æ•´ä¸ªå±å¹•"æ–‡æœ¬èŠ‚ç‚¹
    List<AccessibilityNodeInfo> nodes =
        rootNode.findAccessibilityNodeInfosByText("æ•´ä¸ªå±å¹•");

    if (nodes != null && !nodes.isEmpty()) {
        AccessibilityNodeInfo node = nodes.get(0);

        // å¦‚æœèŠ‚ç‚¹æœ¬èº«å¯ç‚¹å‡»,ç›´æ¥ç‚¹å‡»
        if (node.isClickable()) {
            node.performAction(ACTION_CLICK);
            Log.d(TAG, "æˆåŠŸç‚¹å‡»'æ•´ä¸ªå±å¹•'èŠ‚ç‚¹");
            return;
        }

        // å¦‚æœèŠ‚ç‚¹ä¸å¯ç‚¹å‡»,å°è¯•ç‚¹å‡»çˆ¶èŠ‚ç‚¹
        AccessibilityNodeInfo parent = node.getParent();
        if (parent != null && parent.isClickable()) {
            parent.performAction(ACTION_CLICK);
            Log.d(TAG, "æˆåŠŸç‚¹å‡»'æ•´ä¸ªå±å¹•'çˆ¶èŠ‚ç‚¹");
            return;
        }

        // å¦‚æœçˆ¶èŠ‚ç‚¹ä¹Ÿä¸å¯ç‚¹å‡»,å°è¯•ç¥–çˆ¶èŠ‚ç‚¹
        AccessibilityNodeInfo grandParent = parent.getParent();
        if (grandParent != null && grandParent.isClickable()) {
            grandParent.performAction(ACTION_CLICK);
            Log.d(TAG, "æˆåŠŸç‚¹å‡»'æ•´ä¸ªå±å¹•'ç¥–çˆ¶èŠ‚ç‚¹");
        }
    }
}
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. æ™ºèƒ½çˆ¶èŠ‚ç‚¹æŸ¥æ‰¾

**é—®é¢˜**: æ–‡æœ¬èŠ‚ç‚¹æœ¬èº«å¯èƒ½ä¸å¯ç‚¹å‡»

**è§£å†³æ–¹æ¡ˆ**: å‘ä¸Šéå†çˆ¶èŠ‚ç‚¹,æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ç‚¹å‡»çš„èŠ‚ç‚¹

```
LinearLayout (clickable=true) â† ç‚¹å‡»è¿™ä¸ª!
  â””â”€ LinearLayout (menu_content)
      â””â”€ TextView "æ•´ä¸ªå±å¹•" (clickable=false)
```

#### 2. å¼‚æ­¥å¤„ç†

**é—®é¢˜**: ä¸‹æ‹‰èœå•éœ€è¦æ—¶é—´å¼¹å‡º

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨Thread.sleep()ç­‰å¾…èœå•å‡ºç°

```java
new Thread(() -> {
    try {
        Thread.sleep(500);  // ç­‰å¾…èœå•å¼¹å‡º
        clickWholeScreenOption();
    } catch (Exception e) {
        Log.e(TAG, "å¼‚å¸¸: " + e.getMessage());
    }
}).start();
```

#### 3. çŠ¶æ€æ£€æµ‹

**é—®é¢˜**: éœ€è¦çŸ¥é“å½“å‰å¤„äºå“ªä¸ªçŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**: é€šè¿‡æŒ‰é’®æ–‡å­—åˆ¤æ–­çŠ¶æ€

- "ç»§ç»­" â†’ åˆå§‹çŠ¶æ€,éœ€è¦é€‰æ‹©"æ•´ä¸ªå±å¹•"
- "ç«‹å³å¼€å§‹" â†’ å·²é€‰æ‹©"æ•´ä¸ªå±å¹•",å¯ä»¥å¼€å§‹å½•å±

### æµ‹è¯•éªŒè¯

**éªŒè¯æ­¥éª¤**:
1. å¯åŠ¨è‡ªåŠ¨åŒ–
2. ç‚¹å‡»"å¼€å§‹å½•å±"
3. è§‚å¯Ÿç³»ç»Ÿå¼¹çª—æ˜¯å¦è‡ªåŠ¨å¤„ç†
4. æ£€æŸ¥æ—¥å¿—è¾“å‡º

**é¢„æœŸæ—¥å¿—**:
```
æ‰¾åˆ°'å•ä¸ªåº”ç”¨'ä¸‹æ‹‰æ¡†,å‡†å¤‡ç‚¹å‡»
æˆåŠŸç‚¹å‡»'å•ä¸ªåº”ç”¨'ä¸‹æ‹‰æ¡†
æ‰¾åˆ°'æ•´ä¸ªå±å¹•'æ–‡æœ¬èŠ‚ç‚¹
æˆåŠŸç‚¹å‡»'æ•´ä¸ªå±å¹•'çˆ¶èŠ‚ç‚¹
æ‰¾åˆ°'ç«‹å³å¼€å§‹'æŒ‰é’®,å‡†å¤‡ç‚¹å‡»
æˆåŠŸç‚¹å‡»'ç«‹å³å¼€å§‹'æŒ‰é’®,å½•å±å³å°†å¼€å§‹
```

---

## ğŸ“Š çŠ¶æ€ç›‘æ§

### å½•å±çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IDLE      â”‚ ç©ºé—²çŠ¶æ€
â”‚  (ç©ºé—²)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ å¯åŠ¨åº”ç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAUNCHING  â”‚ å¯åŠ¨ä¸­
â”‚  (å¯åŠ¨ä¸­)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ ç•Œé¢åŠ è½½å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   READY     â”‚ å°±ç»ªçŠ¶æ€
â”‚  (å°±ç»ª)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ ç‚¹å‡»å¼€å§‹å½•å±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STARTING   â”‚ å¯åŠ¨å½•å±ä¸­
â”‚ (å¯åŠ¨ä¸­)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ å¤„ç†ç³»ç»Ÿæƒé™å¼¹çª—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RECORDING   â”‚ å½•å±ä¸­
â”‚ (å½•å±ä¸­)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ ç‚¹å‡»åœæ­¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STOPPING   â”‚ åœæ­¢ä¸­
â”‚ (åœæ­¢ä¸­)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ ä¿å­˜å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETED   â”‚ å®Œæˆ
â”‚  (å®Œæˆ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€ç®¡ç†ä»£ç 

```java
public enum RecordingState {
    IDLE,           // ç©ºé—²
    LAUNCHING,      // å¯åŠ¨ä¸­
    READY,          // å°±ç»ª
    STARTING,       // å¯åŠ¨å½•å±ä¸­
    RECORDING,      // å½•å±ä¸­
    STOPPING,       // åœæ­¢ä¸­
    COMPLETED,      // å®Œæˆ
    ERROR           // é”™è¯¯
}

public class StateManager {
    private RecordingState currentState = RecordingState.IDLE;
    private List<StateChangeListener> listeners = new ArrayList<>();

    public void setState(RecordingState newState) {
        RecordingState oldState = currentState;
        currentState = newState;

        Log.d(TAG, "çŠ¶æ€å˜åŒ–: " + oldState + " -> " + newState);

        // é€šçŸ¥ç›‘å¬å™¨
        for (StateChangeListener listener : listeners) {
            listener.onStateChanged(oldState, newState);
        }
    }

    public RecordingState getState() {
        return currentState;
    }
}
```

---

## âš ï¸ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åœºæ™¯

#### 0. æ— æ³•æ¥æ”¶äº‹ä»¶(æœ€å¸¸è§)

**ç°è±¡**:
- æ—¥å¿—ä¸­æ²¡æœ‰"æ”¶åˆ°äº‹ä»¶"çš„è®°å½•
- è‡ªåŠ¨åŒ–åŠŸèƒ½å®Œå…¨ä¸å·¥ä½œ
- åº”ç”¨å¯åŠ¨åæ²¡æœ‰ä»»ä½•è‡ªåŠ¨æ“ä½œ

**åŸå› **:
æ— éšœç¢æœåŠ¡é…ç½®æ–‡ä»¶ä¸­é™åˆ¶äº†`packageNames`,å¯¼è‡´æ— æ³•æ¥æ”¶ç›®æ ‡åº”ç”¨çš„äº‹ä»¶

**é”™è¯¯é…ç½®**:
```xml
<!-- âŒ é”™è¯¯: åªç›‘å¬ç³»ç»ŸUI -->
<accessibility-service
    android:packageNames="com.android.systemui" />
```

**æ­£ç¡®é…ç½®**:
```xml
<!-- âœ… æ­£ç¡®: ä¸é™åˆ¶packageNames,ç›‘å¬æ‰€æœ‰åº”ç”¨ -->
<accessibility-service
    android:accessibilityEventTypes="typeAllMask"
    android:accessibilityFeedbackType="feedbackGeneric"
    android:accessibilityFlags="flagDefault|flagReportViewIds|flagRetrieveInteractiveWindows"
    android:canPerformGestures="true"
    android:canRetrieveWindowContent="true"
    android:description="@string/accessibility_service_description"
    android:notificationTimeout="100" />
    <!-- æ³¨æ„: æ²¡æœ‰ android:packageNames å±æ€§ -->
```

**è§£å†³æ­¥éª¤**:
1. ä¿®æ”¹é…ç½®æ–‡ä»¶,ç§»é™¤`packageNames`é™åˆ¶
2. é‡æ–°ç¼–è¯‘å®‰è£…APK
3. **é‡æ–°å¼€å¯æ— éšœç¢æœåŠ¡** (å…³é—­å†æ‰“å¼€)
4. æµ‹è¯•æ˜¯å¦èƒ½æ¥æ”¶åˆ°äº‹ä»¶

**éªŒè¯æ–¹æ³•**:
```bash
# æŸ¥çœ‹æ—¥å¿—,åº”è¯¥èƒ½çœ‹åˆ°"æ”¶åˆ°äº‹ä»¶"
adb logcat | grep "æ”¶åˆ°äº‹ä»¶"
```

---

#### 1. UIå…ƒç´ æœªæ‰¾åˆ°

**åŸå› **:
- ç•Œé¢æœªåŠ è½½å®Œæˆ
- Resource IDå˜åŒ–
- åº”ç”¨ç‰ˆæœ¬æ›´æ–°

**å¤„ç†æ–¹æ¡ˆ**:
```java
private void handleElementNotFound(String elementId) {
    retryCount++;

    if (retryCount < MAX_RETRY) {
        Log.w(TAG, "æœªæ‰¾åˆ°å…ƒç´ ,é‡è¯•ä¸­: " + retryCount);
        SystemClock.sleep(1000);
        retryFindElement(elementId);
    } else {
        Log.e(TAG, "æŸ¥æ‰¾å…ƒç´ å¤±è´¥,å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°");
        setState(RecordingState.ERROR);
        notifyError("æ— æ³•æ‰¾åˆ°å½•å±æŒ‰é’®,è¯·æ£€æŸ¥åº”ç”¨ç‰ˆæœ¬");
    }
}
```

#### 2. ç‚¹å‡»æ“ä½œå¤±è´¥

**åŸå› **:
- æ§ä»¶ä¸å¯ç‚¹å‡»
- æ§ä»¶è¢«é®æŒ¡
- æƒé™ä¸è¶³

**å¤„ç†æ–¹æ¡ˆ**:
```java
private boolean performClickWithRetry(AccessibilityNodeInfo node, int maxRetry) {
    for (int i = 0; i < maxRetry; i++) {
        if (node.performAction(AccessibilityNodeInfo.ACTION_CLICK)) {
            Log.d(TAG, "ç‚¹å‡»æˆåŠŸ");
            return true;
        }

        Log.w(TAG, "ç‚¹å‡»å¤±è´¥,é‡è¯•: " + (i + 1));
        SystemClock.sleep(500);
    }

    Log.e(TAG, "ç‚¹å‡»å¤±è´¥,å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°");
    return false;
}
```

#### 3. åº”ç”¨å´©æºƒæˆ–æ— å“åº”

**æ£€æµ‹æ–¹æ³•**:
```java
private void checkAppHealth() {
    // æ£€æŸ¥åº”ç”¨æ˜¯å¦åœ¨å‰å°
    AccessibilityNodeInfo rootNode = getRootInActiveWindow();
    if (rootNode == null) {
        Log.e(TAG, "æ— æ³•è·å–çª—å£ä¿¡æ¯,åº”ç”¨å¯èƒ½å´©æºƒ");
        handleAppCrash();
        return;
    }

    // æ£€æŸ¥åŒ…å
    String packageName = rootNode.getPackageName().toString();
    if (!packageName.equals("com.unitrust.tsa")) {
        Log.w(TAG, "åº”ç”¨å·²åˆ‡æ¢åˆ°åå°");
        handleAppBackground();
    }
}
```

### å¼‚å¸¸æ¢å¤æœºåˆ¶

```java
private void recoverFromError() {
    Log.d(TAG, "å¼€å§‹é”™è¯¯æ¢å¤æµç¨‹");

    // 1. é‡ç½®çŠ¶æ€
    setState(RecordingState.IDLE);
    retryCount = 0;

    // 2. å…³é—­æƒåˆ©å«å£«åº”ç”¨
    closeRightsGuardApp();
    SystemClock.sleep(2000);

    // 3. é‡æ–°å¯åŠ¨
    if (autoRetry) {
        Log.d(TAG, "è‡ªåŠ¨é‡è¯•");
        startAutomation();
    } else {
        Log.d(TAG, "ç­‰å¾…æ‰‹åŠ¨é‡è¯•");
        notifyError("è‡ªåŠ¨åŒ–å¤±è´¥,è¯·æ‰‹åŠ¨é‡è¯•");
    }
}
```

---

## ğŸ”§ è°ƒè¯•è¾…åŠ©å·¥å…·

### UIç»“æ„DumpåŠŸèƒ½ (å¼€å‘ä¸“ç”¨)

**âš ï¸ é‡è¦**: æ­¤åŠŸèƒ½ä»…ç”¨äºå¼€å‘è°ƒè¯•,æ­£å¼å‘å¸ƒç‰ˆæœ¬å°†ç§»é™¤!

#### åŠŸèƒ½æ¦‚è¿°

åœ¨æ‚¬æµ®çª—ä¸­æ·»åŠ "Dump"æŒ‰é’®,å¯ä»¥å¿«é€Ÿdumpå½“å‰ä»»ä½•åº”ç”¨çš„UIç»“æ„ã€‚

#### å®ç°åŸç†

```java
// 1. åœ¨æ‚¬æµ®çª—ä¸­æ·»åŠ DumpæŒ‰é’®
private void addDumpButton() {
    Button dumpButton = new Button(this);
    dumpButton.setText("Dump");
    dumpButton.setOnClickListener(v -> dumpCurrentUI());
    floatingLayout.addView(dumpButton);
}

// 2. è·å–å½“å‰çª—å£çš„UIç»“æ„
private void dumpCurrentUI() {
    AccessibilityNodeInfo rootNode = getRootInActiveWindow();
    if (rootNode == null) {
        showToast("æ— æ³•è·å–UIç»“æ„");
        return;
    }

    // 3. é€’å½’éå†UIæ ‘
    StringBuilder sb = new StringBuilder();
    sb.append("=== UIç»“æ„ Dump ===\n");
    sb.append("åŒ…å: ").append(rootNode.getPackageName()).append("\n");
    sb.append("æ—¶é—´: ").append(getCurrentTime()).append("\n\n");

    dumpNode(rootNode, sb, 0);

    // 4. æ˜¾ç¤ºdumpç»“æœ
    showDumpResult(sb.toString());
}

// 5. é€’å½’éå†èŠ‚ç‚¹
private void dumpNode(AccessibilityNodeInfo node, StringBuilder sb, int depth) {
    if (node == null) return;

    // ç¼©è¿›
    for (int i = 0; i < depth; i++) {
        sb.append(i == depth - 1 ? "â”œâ”€ " : "â”‚   ");
    }

    // èŠ‚ç‚¹ä¿¡æ¯
    sb.append("[").append(node.getClassName()).append("]");
    sb.append(" (clickable=").append(node.isClickable()).append(")\n");

    // Resource ID
    String viewId = node.getViewIdResourceName();
    if (viewId != null && !viewId.isEmpty()) {
        for (int i = 0; i < depth; i++) sb.append("â”‚   ");
        sb.append("ID: ").append(viewId).append("\n");
    }

    // æ–‡æœ¬å†…å®¹
    CharSequence text = node.getText();
    if (text != null && text.length() > 0) {
        for (int i = 0; i < depth; i++) sb.append("â”‚   ");
        sb.append("Text: \"").append(text).append("\"\n");
    }

    // å†…å®¹æè¿°
    CharSequence desc = node.getContentDescription();
    if (desc != null && desc.length() > 0) {
        for (int i = 0; i < depth; i++) sb.append("â”‚   ");
        sb.append("Desc: \"").append(desc).append("\"\n");
    }

    // ä½ç½®å’Œå¤§å°
    Rect bounds = new Rect();
    node.getBoundsInScreen(bounds);
    for (int i = 0; i < depth; i++) sb.append("â”‚   ");
    sb.append("Bounds: ").append(bounds.toShortString()).append("\n");

    // éå†å­èŠ‚ç‚¹
    int childCount = node.getChildCount();
    for (int i = 0; i < childCount; i++) {
        AccessibilityNodeInfo child = node.getChild(i);
        dumpNode(child, sb, depth + 1);
        if (child != null) child.recycle();
    }
}

// 6. æ˜¾ç¤ºdumpç»“æœ
private void showDumpResult(String dumpText) {
    Intent intent = new Intent(this, DumpResultActivity.class);
    intent.putExtra("dump_text", dumpText);
    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
    startActivity(intent);
}
```

#### DumpResultActivityç•Œé¢

```java
public class DumpResultActivity extends AppCompatActivity {
    private TextView dumpTextView;
    private String dumpText;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_dump_result);

        dumpText = getIntent().getStringExtra("dump_text");
        dumpTextView = findViewById(R.id.dump_text);
        dumpTextView.setText(dumpText);

        // å¤åˆ¶å…¨éƒ¨æŒ‰é’®
        findViewById(R.id.btn_copy).setOnClickListener(v -> copyToClipboard());

        // ä¿å­˜æ–‡ä»¶æŒ‰é’®
        findViewById(R.id.btn_save).setOnClickListener(v -> saveToFile());

        // åˆ†äº«æŒ‰é’®
        findViewById(R.id.btn_share).setOnClickListener(v -> shareText());
    }

    private void copyToClipboard() {
        ClipboardManager clipboard = (ClipboardManager)
            getSystemService(Context.CLIPBOARD_SERVICE);
        ClipData clip = ClipData.newPlainText("UI Dump", dumpText);
        clipboard.setPrimaryClip(clip);
        Toast.makeText(this, "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", Toast.LENGTH_SHORT).show();
    }

    private void saveToFile() {
        String fileName = "dump_" + System.currentTimeMillis() + ".txt";
        File file = new File(getExternalFilesDir(Environment.DIRECTORY_DOCUMENTS),
                            "æƒåˆ©å«å£«å–è¯/" + fileName);

        try (FileWriter writer = new FileWriter(file)) {
            writer.write(dumpText);
            Toast.makeText(this, "å·²ä¿å­˜: " + file.getAbsolutePath(),
                          Toast.LENGTH_LONG).show();
        } catch (IOException e) {
            Toast.makeText(this, "ä¿å­˜å¤±è´¥: " + e.getMessage(),
                          Toast.LENGTH_SHORT).show();
        }
    }

    private void shareText() {
        Intent shareIntent = new Intent(Intent.ACTION_SEND);
        shareIntent.setType("text/plain");
        shareIntent.putExtra(Intent.EXTRA_TEXT, dumpText);
        startActivity(Intent.createChooser(shareIntent, "åˆ†äº«UI Dump"));
    }
}
```

#### ä½¿ç”¨æµç¨‹

```
1. å¯åŠ¨è‡ªåŠ¨åŒ–APK
2. å¼€å¯æ‚¬æµ®çª—
3. æ‰“å¼€éœ€è¦dumpçš„åº”ç”¨(å¦‚æƒåˆ©å«å£«)
4. ç‚¹å‡»æ‚¬æµ®çª—ä¸­çš„"Dump"æŒ‰é’®
5. æŸ¥çœ‹dumpç»“æœ
6. å¤åˆ¶/ä¿å­˜/åˆ†äº«dumpä¿¡æ¯
```

#### âš ï¸ ç§»é™¤æé†’

**æ­£å¼å‘å¸ƒå‰å¿…é¡»ç§»é™¤æ­¤åŠŸèƒ½**:
1. åˆ é™¤æ‚¬æµ®çª—ä¸­çš„DumpæŒ‰é’®
2. åˆ é™¤DumpResultActivity
3. åˆ é™¤ç›¸å…³å¸ƒå±€æ–‡ä»¶
4. åˆ é™¤dumpç›¸å…³ä»£ç 

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¼€å‘æŒ‡å—](./å¼€å‘æŒ‡å—.md) - å¼€å‘ç¯å¢ƒå’Œå·¥å…·
- [å¸¸è§é—®é¢˜](./å¸¸è§é—®é¢˜.md) - é—®é¢˜æ’æŸ¥å’Œè§£å†³
- [æƒåˆ©å«å£«åº”ç”¨åˆ†æ](../æƒåˆ©å«å£«åº”ç”¨åˆ†ææŠ¥å‘Š.md) - ç›®æ ‡åº”ç”¨è¯¦ç»†åˆ†æ

---

[â† è¿”å›README](../README.md)

**æœ€åæ›´æ–°**: 2025-01-20

