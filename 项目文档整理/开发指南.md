# 开发指南

[← 返回README](../README.md)

---

## 📋 目录

1. [环境配置](#环境配置)
2. [技术架构](#技术架构)
3. [开发流程](#开发流程)
4. [核心模块](#核心模块)
5. [调试技巧](#调试技巧)
6. [部署指南](#部署指南)

---

## 🔧 环境配置

### 开发环境要求

#### 必需软件
- **Android Studio**: Arctic Fox (2020.3.1) 或更高版本
- **JDK**: JDK 11 或更高版本
- **Gradle**: 7.0+ (通过Android Studio自动管理)
- **Android SDK**: API 26 - API 33

#### 推荐工具
- **ADB**: Android调试桥 (Android SDK自带)
- **Scrcpy**: 屏幕镜像工具 (用于远程调试)
- **Vysor**: 设备控制工具 (可选)

### 测试设备要求

#### 硬件要求
- **设备品牌**: vivo (优先)、小米、华为等
- **Android版本**: Android 8.0 (API 26) 或更高
- **内存**: 4GB+ RAM
- **存储**: 2GB+ 可用空间

#### 软件要求
- 已安装权利卫士应用 (v4.7.0.0+)
- 已开启开发者选项 (仅开发阶段)
- 已开启USB调试 (仅开发阶段)
- 已授予必要权限

#### ⚠️ 重要: 环境检测问题

**权利卫士环境检测**:
- 🔴 权利卫士会检测开发者选项和USB调试
- 🔴 检测到异常环境会拒绝运行
- 🔴 这会影响取证的合法性和有效性

**开发策略**:
```
开发阶段 (不运行权利卫士)
    ↓
开启调试 → 开发代码 → 测试功能
    ↓
使用阶段 (运行权利卫士)
    ↓
关闭调试 → 环境干净 → 取证有效
```

**为什么不建议Root**:
- ❌ Root会留下痕迹,可能被检测
- ❌ 影响取证的法律效力
- ❌ 不符合客户"环境干净"的要求
- ✅ 使用文字查找定位,不需要Root

**手动记录法**:
- 临时关闭调试,手动操作权利卫士
- 截图记录所有按钮文字和界面元素
- 重新开启调试,根据记录开发代码
- 使用文字查找定位,不依赖dump页面
- 详见下文"调试技巧"章节

### 项目配置

#### 1. 克隆项目
```bash
git clone <项目地址>
cd 权利卫士取证自动化
```

#### 2. 导入Android Studio
1. 打开Android Studio
2. 选择 "Open an Existing Project"
3. 选择项目根目录
4. 等待Gradle同步完成

#### 3. 配置签名
在 `app/build.gradle` 中配置签名信息:
```gradle
android {
    signingConfigs {
        release {
            storeFile file("your-keystore.jks")
            storePassword "your-password"
            keyAlias "your-alias"
            keyPassword "your-password"
        }
    }
}
```

---

## 🏗️ 技术架构

### 整体架构

```
┌─────────────────────────────────────┐
│         自动化APK应用                │
├─────────────────────────────────────┤
│  UI层 (Activity/Fragment)           │
│  - 任务配置界面                      │
│  - 状态监控界面                      │
│  - 日志查看界面                      │
├─────────────────────────────────────┤
│  业务逻辑层 (Service)                │
│  - AutomationService (核心服务)     │
│  - TaskManager (任务管理)           │
│  - StateMonitor (状态监控)          │
├─────────────────────────────────────┤
│  自动化层 (Accessibility)            │
│  - AccessibilityService (无障碍)    │
│  - UIAutomator (UI自动化)           │
│  - EventDispatcher (事件分发)       │
├─────────────────────────────────────┤
│  工具层 (Utils)                      │
│  - Logger (日志)                     │
│  - PermissionHelper (权限)          │
│  - DeviceHelper (设备信息)          │
└─────────────────────────────────────┘
         ↓ 控制
┌─────────────────────────────────────┐
│         权利卫士应用                 │
│     (com.unitrust.tsa)              │
└─────────────────────────────────────┘
```

### 核心技术选型

#### 1. Accessibility Service (无障碍服务)
- **作用**: 获取UI元素信息,模拟用户操作
- **优势**: 系统级服务,稳定可靠,无需Root
- **限制**: 需要用户手动开启权限

#### 2. UI Automator
- **作用**: 辅助定位UI元素
- **优势**: 支持跨应用操作
- **使用**: 配合Accessibility Service使用

#### 3. Foreground Service (前台服务)
- **作用**: 保持应用在后台运行
- **优势**: 不易被系统杀死
- **要求**: 必须显示通知栏图标

---

## 🔄 开发流程

### 1. 需求分析阶段
1. 明确自动化目标和流程
2. 分析权利卫士应用UI结构
3. 确定需要自动化的操作步骤
4. 评估技术可行性

### 2. 设计阶段
1. 设计自动化流程图
2. 设计数据结构和接口
3. 设计错误处理机制
4. 设计日志记录方案

### 3. 开发阶段
1. 创建Accessibility Service
2. 实现UI元素定位逻辑
3. 实现自动化操作流程
4. 实现任务管理功能
5. 实现状态监控功能

### 4. 测试阶段
1. 单元测试 (核心逻辑)
2. 集成测试 (完整流程)
3. 真机测试 (vivo设备)
4. 压力测试 (批量任务)

### 5. 部署阶段
1. 打包APK
2. 签名APK
3. 安装到目标设备
4. 配置设备权限
5. 验证功能正常

---

## 🧩 核心模块

### 1. AutomationAccessibilityService

**功能**: 核心无障碍服务,负责UI自动化操作

**关键方法**:
```java
public class AutomationAccessibilityService extends AccessibilityService {
    
    // 监听UI事件
    @Override
    public void onAccessibilityEvent(AccessibilityEvent event) {
        // 处理UI变化事件
    }
    
    // 查找UI元素
    private AccessibilityNodeInfo findNodeByResourceId(String resourceId) {
        // 通过Resource ID查找节点
    }
    
    // 点击UI元素
    private boolean clickNode(AccessibilityNodeInfo node) {
        // 模拟点击操作
    }
}
```

**配置文件**: `res/xml/accessibility_service_config.xml`

### 2. TaskManager (任务管理器)

**功能**: 管理自动化任务队列和执行

**关键功能**:
- 任务队列管理
- 任务调度执行
- 任务状态跟踪
- 失败重试机制

**核心代码**:
```java
public class TaskManager {
    private Queue<AutomationTask> taskQueue;
    private TaskExecutor executor;

    // 添加任务
    public void addTask(AutomationTask task) {
        taskQueue.offer(task);
    }

    // 执行下一个任务
    public void executeNext() {
        AutomationTask task = taskQueue.poll();
        if (task != null) {
            executor.execute(task);
        }
    }
}
```

### 3. StateMonitor (状态监控)

**功能**: 监控录屏状态和应用状态

**监控内容**:
- 权利卫士应用是否在前台
- 录屏是否已开始
- 录屏是否已结束
- 是否出现错误弹窗

**实现方式**:
- 通过Accessibility Event监听UI变化
- 通过定时器轮询检查状态
- 通过通知栏监听录屏状态

### 4. FloatingWindowService (悬浮窗服务)

**功能**: 提供悬浮窗控制界面

**核心功能**:
- 悬浮窗显示/隐藏
- 拖动功能
- 自动化控制按钮
- UI Dump功能(开发专用)

**拖动事件处理**:
```java
public class FloatingWindowService extends Service {

    // 设置拖动监听器
    private void setupDrag() {
        layoutFull.setOnTouchListener(new View.OnTouchListener() {
            private boolean isDragging = false;

            @Override
            public boolean onTouch(View v, MotionEvent event) {
                switch (event.getAction()) {
                    case MotionEvent.ACTION_DOWN:
                        // 不拦截,让按钮可以响应
                        return false;

                    case MotionEvent.ACTION_MOVE:
                        // 移动距离>10像素才认为是拖动
                        if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                            isDragging = true;
                            // 更新悬浮窗位置
                            params.x = initialX + (int) deltaX;
                            params.y = initialY + (int) deltaY;
                            windowManager.updateViewLayout(floatingView, params);
                            return true; // 拦截拖动事件
                        }
                        return false;

                    case MotionEvent.ACTION_UP:
                        // 拖动结束拦截,点击不拦截
                        return isDragging;
                }
                return false;
            }
        });
    }
}
```

**UI Dump功能**:
```java
// 导出UI结构为Markdown文件并分享
private void dumpCurrentUI() {
    // 1. 获取UI树根节点
    AccessibilityNodeInfo rootNode = getRootInActiveWindow();

    // 2. 遍历UI树,生成Markdown
    StringBuilder markdown = new StringBuilder();
    traverseNode(rootNode, markdown, 0);

    // 3. 保存到Documents/RightsGuard/目录
    File file = saveToFile(markdown.toString());

    // 4. 创建分享Intent
    Intent shareIntent = new Intent(Intent.ACTION_SEND);
    shareIntent.setType("text/markdown");
    shareIntent.putExtra(Intent.EXTRA_STREAM, uri);

    // 5. 弹出分享对话框
    startActivity(Intent.createChooser(shareIntent, "分享UI Dump"));
}
```

### 5. PermissionHelper (权限助手)

**功能**: 检查和申请必要权限

**需要的权限**:
- 无障碍服务权限
- 悬浮窗权限
- 通知权限
- 存储权限 (Android 13+需要READ_MEDIA_IMAGES)

**核心方法**:
```java
public class PermissionHelper {

    // 检查无障碍服务是否开启
    public static boolean isAccessibilityEnabled(Context context) {
        // 检查逻辑
    }

    // 跳转到无障碍设置页面
    public static void openAccessibilitySettings(Context context) {
        Intent intent = new Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS);
        context.startActivity(intent);
    }

    // 请求存储权限
    private void requestStoragePermission() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
            if (checkSelfPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE)
                != PackageManager.PERMISSION_GRANTED) {
                requestPermissions(new String[]{
                    Manifest.permission.WRITE_EXTERNAL_STORAGE,
                    Manifest.permission.READ_EXTERNAL_STORAGE
                }, 100);
            }
        }
    }
}
```

---

## 🐛 调试技巧

### 🔧 UI结构Dump功能 (开发调试专用)

**⚠️ 重要提示**: 此功能仅用于开发调试,正式发布版本将移除!

#### 功能说明

在悬浮窗中添加"Dump"按钮,可以快速dump当前任何应用的UI结构,方便开发调试。

**使用场景**:
- 快速查看权利卫士应用的UI结构
- 获取控件的Resource ID、文本、层级等信息
- 不需要连接电脑,直接在手机上操作
- 复制dump信息发送给开发者

**使用方法**:
1. 打开自动化APK,启动悬浮窗
2. 打开需要dump的应用(如权利卫士)
3. 点击悬浮窗中的"Dump"按钮
4. 查看dump结果界面
5. 点击"复制全部"复制到剪贴板
6. 发送给开发者或保存到文件

**输出信息**:
```
=== UI结构 Dump ===
包名: com.unitrust.tsa
Activity: cn.tsa.activity.MainActivity
时间: 2025-01-20 21:00:00

[LinearLayout] (clickable=false)
  ID: android:id/content
  Bounds: [0,0][1080,2400]

  ├─ [TextView] (clickable=false)
  │   ID: com.unitrust.tsa:id/title
  │   Text: "录屏取证"
  │   Bounds: [40,100][1040,200]
  │
  └─ [Button] (clickable=true)
      ID: com.unitrust.tsa:id/btn_start
      Text: "开始录屏"
      Bounds: [40,1800][1040,1950]
```

**功能按钮**:
- **复制全部**: 复制到剪贴板,可以粘贴到微信等
- **保存文件**: 保存到Documents/权利卫士取证/dump_时间戳.txt
- **分享**: 调用系统分享,可以分享到微信、QQ等

**⚠️ 移除提醒**:
- 此功能仅用于开发阶段
- 正式发布前必须移除此功能
- 避免用户误操作或泄露信息

---

### ⚠️ 重要: 手动记录法 (传统方法)

由于权利卫士会检测开发者选项,我们也可以采用**手动记录法**进行开发:

#### 步骤1: 准备记录 (1分钟)
```
准备好:
- 📱 手机
- 📝 笔记本或电脑
- 📸 截图工具
```

#### 步骤2: 关闭调试 (1分钟)
```bash
# 方法1: 通过adb关闭(在断开前执行)
adb shell settings put global development_settings_enabled 0

# 方法2: 手动关闭
设置 > 系统 > 开发者选项 > 关闭
```

#### 步骤3: 手动操作并记录 (10分钟)
```
完整走一遍流程,每个步骤:
1. 📸 截图
2. 📝 记录所有文字(按钮、提示、标题、选项)
3. 📝 记录操作顺序
4. 📝 记录特殊情况

示例:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
步骤1: 启动权利卫士
  📸 截图主界面
  📝 记录: 应用包名、界面元素

步骤2: 点击"录屏取证"
  📸 截图
  📝 记录: 按钮文字 "录屏取证"

步骤3: 填写备注
  📸 截图
  📝 记录: 输入框提示文字

步骤4: 点击"开始录屏取证"
  📸 截图
  📝 记录: 按钮文字

步骤5: 系统权限弹窗
  📸 截图
  📝 记录: 所有选项和按钮文字
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

#### 步骤4: 重新开启调试 (2分钟)
```
设置 > 关于手机 > 连续点击版本号7次
设置 > 开发者选项 > 开启
设置 > 开发者选项 > 无线调试 > 开启
```

#### 步骤5: 根据记录开发代码
```java
// 使用文字查找定位元素
List<AccessibilityNodeInfo> nodes =
    rootNode.findAccessibilityNodeInfosByText("录屏取证");

if (nodes != null && !nodes.isEmpty()) {
    nodes.get(0).performAction(ACTION_CLICK);
}
```

**优点**:
- ✅ 不需要dump页面
- ✅ 不需要root
- ✅ 使用时环境100%干净
- ✅ 文字查找稳定可靠

---

### 1. 使用ADB查看日志

```bash
# 查看应用日志
adb logcat | grep "AutomationService"

# 查看Accessibility事件
adb logcat | grep "AccessibilityEvent"

# 清除日志
adb logcat -c
```

### 2. 使用Layout Inspector (仅开发阶段)

⚠️ 注意: 需要开启开发者选项,仅在开发阶段使用

1. 在Android Studio中打开 Tools > Layout Inspector
2. 选择目标设备和进程
3. 查看UI层级结构
4. 获取Resource ID和控件属性

### 3. 使用UI Automator Viewer (仅开发阶段)

⚠️ 注意: 需要开启开发者选项,仅在开发阶段使用

```bash
# 启动UI Automator Viewer
cd $ANDROID_HOME/tools/bin
./uiautomatorviewer
```

功能:
- 截取当前屏幕UI
- 查看控件层级
- 获取控件属性
- 定位Resource ID

**限制**: 由于权利卫士检测开发者选项,建议使用手动记录法代替

### 4. 远程调试

使用Scrcpy进行远程调试:
```bash
# 安装scrcpy
brew install scrcpy

# 启动镜像
scrcpy

# 启动镜像并录屏
scrcpy --record automation-test.mp4
```

### 5. 日志记录

在代码中添加详细日志:
```java
private static final String TAG = "AutomationService";

Log.d(TAG, "开始查找录屏按钮");
Log.d(TAG, "找到按钮: " + node.getText());
Log.e(TAG, "点击失败: " + e.getMessage());
```

---

## 🚀 部署指南

### 1. 打包APK

#### Debug版本
```bash
./gradlew assembleDebug
```
输出: `app/build/outputs/apk/debug/app-debug.apk`

#### Release版本
```bash
./gradlew assembleRelease
```
输出: `app/build/outputs/apk/release/app-release.apk`

### 2. 签名APK

如果Release版本未自动签名:
```bash
jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
  -keystore your-keystore.jks \
  app-release-unsigned.apk your-alias
```

### 3. 安装到设备

```bash
# 通过ADB安装
adb install app-release.apk

# 覆盖安装
adb install -r app-release.apk

# 安装到多个设备
adb -s <device-id> install app-release.apk
```

### 4. 配置设备权限

#### vivo设备配置清单
1. **开启无障碍服务**
   - 设置 > 更多设置 > 无障碍 > 已安装的服务
   - 找到"权利卫士自动化"并开启

2. **开启悬浮窗权限**
   - 设置 > 应用与权限 > 权限管理 > 悬浮窗
   - 找到"权利卫士自动化"并允许

3. **开启自启动**
   - 设置 > 应用与权限 > 自启动
   - 找到"权利卫士自动化"并允许

4. **关闭电池优化**
   - 设置 > 电池 > 后台高耗电
   - 找到"权利卫士自动化"并允许

5. **允许后台运行**
   - 设置 > 应用与权限 > 应用管理
   - 找到"权利卫士自动化" > 权限 > 后台弹出界面
   - 设置为"允许"

### 5. 验证功能

#### 功能检查清单
- [ ] 应用能正常启动
- [ ] 无障碍服务已开启
- [ ] 能自动启动权利卫士
- [ ] 能自动点击录屏按钮
- [ ] 能处理系统权限弹窗
- [ ] 能监控录屏状态
- [ ] 能自动停止录屏
- [ ] 日志记录正常

#### 测试命令
```bash
# 查看应用是否安装
adb shell pm list packages | grep automation

# 查看应用进程
adb shell ps | grep automation

# 查看无障碍服务状态
adb shell settings get secure enabled_accessibility_services
```

---

## 📝 开发规范

### 代码规范
- 使用Java/Kotlin标准命名规范
- 类名使用大驼峰 (PascalCase)
- 方法名使用小驼峰 (camelCase)
- 常量使用全大写下划线 (UPPER_SNAKE_CASE)
- 添加必要的中文注释

### 日志规范
- 使用统一的TAG
- Debug日志使用Log.d()
- 错误日志使用Log.e()
- 重要操作记录日志
- 避免敏感信息泄露

### 异常处理
- 所有可能抛出异常的代码都要try-catch
- 捕获异常后记录日志
- 提供友好的错误提示
- 实现失败重试机制

---

## 🔗 相关资源

### 官方文档
- [Android Accessibility Service](https://developer.android.com/guide/topics/ui/accessibility/service)
- [Android UI Automator](https://developer.android.com/training/testing/ui-automator)
- [Android Foreground Service](https://developer.android.com/guide/components/foreground-services)

### 开发工具
- [Android Studio](https://developer.android.com/studio)
- [Scrcpy](https://github.com/Genymobile/scrcpy)
- [ADB](https://developer.android.com/studio/command-line/adb)

---

[← 返回README](../README.md)

**最后更新**: 2026-01-19

